# Typecho 高德地图路径规划插件

## 功能特性

- **路径规划**：支持驾车、步行、骑行三种路径规划方式
- **多点路径**：支持最多16个路径点（1个起点、1个终点、最多14个途经点）
- **实时路况**：可选择显示实时路况信息
- **多种地图主题**：提供11种不同的地图主题样式
- **可视化编辑器**：通过可视化界面添加路径规划，无需编写代码
- **短代码支持**：支持使用短代码直接插入路径规划
- **响应式设计**：地图自适应容器宽度，支持移动设备
- **路径动画**：路径绘制带有动画效果
- **信息窗口**：点击路径点可显示详细信息
- **错误处理**：当路径规划失败时，自动绘制直线连接各点

## 地图主题

插件提供以下11种地图主题：

1. **normal**（标准）- 默认地图样式
2. **dark**（暗色）- 深色主题地图
3. **light**（亮色）- 明亮主题地图
4. **whitesmoke**（烟熏白）- 简洁白色主题
5. **fresh**（清新）- 清新自然主题
6. **grey**（灰色）- 简约灰色主题
7. **graffiti**（涂鸦）- 涂鸦艺术主题
8. **macaron**（马卡龙）- 甜美色彩主题
9. **blue**（蓝色）- 蓝色主题
10. **darkblue**（深蓝）- 深蓝色主题
11. **wine**（酒红）- 酒红色主题

## 安装方法

1. 下载插件文件并解压
2. 将整个 `AMapRoutePlugin` 文件夹上传到 Typecho 的 `usr/plugins/` 目录
3. 登录 Typecho 后台，进入「控制台」→「插件」
4. 找到「高德地图路径规划插件」并点击「启用」

## 配置说明

启用插件后，需要进行以下配置：

### 基本配置

1. **API Key**：必填，从[高德开放平台](https://lbs.amap.com/)申请的Web服务API Key
2. **安全密钥**：必填，从高德开放平台获取的安全密钥，用于API请求签名
3. **默认缩放级别**：地图初始缩放级别，范围1-18，默认12
4. **默认路径类型**：默认路径规划方式（driving/walking/cycling）
5. **默认地图主题**：默认地图主题样式
6. **默认显示路况**：是否默认显示实时路况
7. **最大途经点数量**：限制最多可添加的途经点数量，范围1-16，默认16

### API Key 申请方法

1. 访问[高德开放平台](https://lbs.amap.com/)并注册账号
2. 创建应用并选择「Web端」
3. 获取API Key和安全密钥
4. 在插件配置中填入相应信息

## 使用方法

### 方法一：使用可视化编辑器（推荐）

1. 在文章/页面编辑页面，点击工具栏中的「🛣️」按钮
2. 在弹出的对话框中设置路径参数：
   - 选择路径类型（驾车/步行/骑行）
   - 设置地图缩放级别（1-18）
   - 选择地图主题
   - 是否显示实时路况
3. 添加路径点：
   - 输入起点经纬度
   - 输入终点经纬度
   - 可根据需要添加途经点（最多14个）
4. 点击「确认插入」按钮

### 方法二：使用短代码

直接在文章内容中插入以下格式的短代码：

```
[route type=driving zoom=12 theme=normal traffic=0 point1="116.397428,39.90923" point2="116.397428,39.90923"]
```

#### 短代码参数说明

- **type**：路径类型，可选值：
  - `driving`（驾车，默认）
  - `walking`（步行）
  - `cycling`（骑行）
- **zoom**：缩放级别，范围1-18，默认12
- **theme**：地图主题，详见上文地图主题列表，默认normal
- **traffic**：是否显示实时路况，0（不显示，默认）或1（显示）
- **point1**、**point2**...：路径点坐标，格式为"经度,纬度"，至少需要2个点，最多支持16个点

#### 短代码示例

1. **基本驾车路径**：
   ```
   [route type=driving point1="116.397428,39.90923" point2="116.407428,39.91923"]
   ```

2. **带途经点的步行路径**：
   ```
   [route type=walking point1="116.397428,39.90923" point2="116.407428,39.91923" point3="116.417428,39.92923"]
   ```

3. **自定义主题和缩放级别**：
   ```
   [route type=cycling zoom=15 theme=dark traffic=1 point1="116.397428,39.90923" point2="116.407428,39.91923"]
   ```

## 获取经纬度坐标

有多种方法可以获取地点的经纬度：

1. **高德地图坐标拾取工具**：
   - 访问 https://lbs.amap.com/tools/picker
   - 在地图上点击或搜索地点
   - 复制显示的经纬度坐标

2. **谷歌地图**：
   - 在谷歌地图上右键点击地点
   - 选择"经纬度"选项
   - 复制显示的坐标

3. **手机GPS**：
   - 使用手机地图应用获取当前位置坐标
   - 将坐标输入到插件中

## 高级功能

### 路径规划失败处理

当路径规划失败时（如网络问题、API限制等），插件会自动：
1. 在控制台输出错误信息
2. 在地图上绘制直线连接所有路径点
3. 显示所有路径点的标记和信息窗口

### 路径点信息窗口

每个路径点都有可点击的信息窗口，显示：
- 路径点序号（起点、终点、途经点）
- 经纬度坐标

### 响应式设计

地图容器会自动适应父容器的宽度，确保在不同设备上都能正常显示。

## 常见问题

### 1. 地图不显示或显示空白

- 检查API Key和安全密钥是否正确填写
- 确认网络连接正常
- 检查浏览器控制台是否有错误信息
- 确认API Key有足够的调用额度

### 2. 路径规划失败

- 检查路径点坐标是否正确
- 确认路径点数量不超过16个
- 检查网络连接和API调用限制
- 插件会自动绘制直线作为备用方案

### 3. 编辑器按钮不显示

- 确认插件已正确启用
- 检查浏览器控制台是否有JavaScript错误
- 尝试刷新编辑器页面

### 4. 短代码不生效

- 确认短代码格式正确
- 检查参数值是否有效
- 确认经纬度坐标格式为"经度,纬度"

## 技术实现

### 前端技术栈

- **高德地图JavaScript API**：地图渲染和路径规划
- **jQuery**：DOM操作和事件处理
- **Bootstrap样式**：模态框和表单样式

### 核心功能实现

1. **路径规划**：使用高德地图API的路径规划服务
2. **标记点管理**：动态添加、删除路径点标记
3. **短代码解析**：正则表达式匹配和参数提取
4. **错误处理**：路径规划失败时的备用方案

### 安全性

- API密钥安全存储
- 输入参数验证和过滤
- XSS防护

## 更新日志

### v1.2.0 (2023-12-20)

- 新增：支持最多16个路径点（1个起点、1个终点、最多14个途经点）
- 新增：路径规划失败时自动绘制直线连接各点
- 新增：路径点信息窗口显示
- 改进：编辑器界面优化，支持动态添加/删除途经点
- 改进：错误处理和用户提示
- 修复：缩放级别验证问题

### v1.1.0 (2023-11-15)

- 新增：实时路况显示选项
- 新增：11种地图主题支持
- 改进：地图加载性能优化
- 改进：移动设备适配

### v1.0.0 (2023-10-01)

- 初始版本发布
- 支持基本的路径规划功能
- 支持驾车、步行、骑行三种路径类型
- 提供可视化编辑器和短代码两种使用方式

## 作者

王叨叨 - https://wangdaodao.com/